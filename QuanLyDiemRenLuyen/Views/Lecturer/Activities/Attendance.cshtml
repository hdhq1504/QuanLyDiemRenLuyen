@model QuanLyDiemRenLuyen.Models.AttendanceViewModel
@{
    ViewBag.Title = "Điểm Danh - " + Model.ActivityTitle;
    Layout = "~/Views/Shared/_LecturerLayout.cshtml";
    
    bool isConfirmed = Model.AttendanceStatus == "CONFIRMED";
    bool hasActivityStarted = DateTime.Now >= Model.ActivityStartAt;
    bool canEdit = !isConfirmed && hasActivityStarted;
}

<div class="container-fluid">
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-header h2 {
            margin: 0;
            font-size: 24px;
            color: #0f172a;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .info-card .label {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .info-card .value {
            font-size: 18px;
            font-weight: 600;
            color: #0f172a;
        }

        .info-card.highlight {
            background: #667eea;
            color: white;
        }

        .info-card.highlight .label {
            color: rgba(255,255,255,0.8);
        }

        .info-card.highlight .value {
            color: white;
            font-size: 24px;
        }

        .info-card.danger {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }

        .info-card.danger .label,
        .info-card.danger .value {
            color: #dc2626;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.total { background: #e0e7ff; color: #4f46e5; }
        .stat-icon.present { background: #d1fae5; color: #059669; }
        .stat-icon.absent { background: #fee2e2; color: #dc2626; }
        .stat-icon.pending { background: #fef3c7; color: #d97706; }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #0f172a;
        }

        .stat-label {
            font-size: 13px;
            color: #64748b;
        }

        .quick-actions {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .quick-actions h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
        }

        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-outline { border: 1px solid #e2e8f0; background: white; color: #64748b; }

        .btn-lg {
            padding: 14px 24px;
            font-size: 15px;
        }

        .filter-bar {
            background: white;
            padding: 16px 20px;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-control {
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #5a6c7d;
            border-bottom: 2px solid #e9ecef;
            font-size: 14px;
        }

        .table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .student-name {
            font-weight: 600;
            color: #0f172a;
        }

        .student-code {
            font-size: 13px;
            color: #64748b;
        }

        .attendance-select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            min-width: 150px;
        }

        .attendance-select.present {
            border-color: #10b981;
            background: #ecfdf5;
            color: #059669;
        }

        .attendance-select.absent {
            border-color: #ef4444;
            background: #fef2f2;
            color: #dc2626;
        }

        .attendance-select.pending {
            border-color: #f59e0b;
            background: #fffbeb;
            color: #d97706;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-in_progress { background: #d1ecf1; color: #0c5460; }
        .badge-completed { background: #e0e7ff; color: #4f46e5; }
        .badge-confirmed { background: #d4edda; color: #155724; }
        .badge-present { background: #d4edda; color: #155724; }
        .badge-absent { background: #f8d7da; color: #721c24; }

        .confirm-section {
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .confirm-section h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 600;
            color: #166534;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .score-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
        }

        .score-item .label {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .score-item .value {
            font-size: 24px;
            font-weight: 700;
        }

        .score-item .value.positive { color: #059669; }
        .score-item .value.negative { color: #dc2626; }

        .confirmed-section {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 24px;
        }
    </style>

    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h2><i class="fas fa-user-check" style="color: #667eea;"></i> Điểm Danh</h2>
            <div style="color: #64748b; font-size: 14px; margin-top: 4px;">@Model.ActivityTitle</div>
        </div>
        <div class="header-actions">
            <span class="badge badge-@Model.AttendanceStatus.ToLower()">
                @switch (Model.AttendanceStatus)
                {
                    case "PENDING":
                        <i class="fas fa-clock"></i>
                        <text>Chưa bắt đầu</text>
                        break;
                    case "IN_PROGRESS":
                        <i class="fas fa-spinner"></i>
                        <text>Đang điểm danh</text>
                        break;
                    case "COMPLETED":
                        <i class="fas fa-check"></i>
                        <text>Hoàn thành</text>
                        break;
                    case "CONFIRMED":
                        <i class="fas fa-check-double"></i>
                        <text>Đã xác nhận</text>
                        break;
                }
            </span>
            <a href="@Url.RouteUrl("LecturerActivities", new { action = "Index" })" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>

    <!-- Info Cards -->
    <div class="stats-grid">
        <div class="info-card">
            <div class="label">Thời gian</div>
            <div class="value">@Model.ActivityStartAt.ToString("dd/MM/yyyy HH:mm")</div>
        </div>
        <div class="info-card">
            <div class="label">Địa điểm</div>
            <div class="value">@(string.IsNullOrEmpty(Model.Location) ? "Chưa xác định" : Model.Location)</div>
        </div>
        <div class="info-card highlight">
            <div class="label">Điểm cộng khi có mặt</div>
            <div class="value">+@Model.ActivityPoints điểm</div>
        </div>
        <div class="info-card danger">
            <div class="label">Điểm trừ khi vắng</div>
            <div class="value" style="font-size: 24px; font-weight: 700;">-@Model.AbsencePenalty điểm</div>
        </div>
    </div>

    @if (!hasActivityStarted)
    {
        <div style="margin-bottom: 24px; padding: 16px 20px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 12px; color: #92400e; font-size: 14px;">
            <i class="fas fa-lock"></i> <strong>Chưa thể điểm danh:</strong> Hoạt động chưa bắt đầu. Điểm danh sẽ mở lúc <strong>@Model.ActivityStartAt.ToString("dd/MM/yyyy HH:mm")</strong>.
        </div>
    }

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon total"><i class="fas fa-users"></i></div>
            <div>
                <div class="stat-value">@Model.TotalStudents</div>
                <div class="stat-label">Tổng số</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon present"><i class="fas fa-check"></i></div>
            <div>
                <div class="stat-value">@Model.PresentCount</div>
                <div class="stat-label">Có mặt</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon absent"><i class="fas fa-times"></i></div>
            <div>
                <div class="stat-value">@Model.AbsentCount</div>
                <div class="stat-label">Vắng</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon pending"><i class="fas fa-clock"></i></div>
            <div>
                <div class="stat-value">@Model.PendingCount</div>
                <div class="stat-label">Chưa điểm danh</div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    @if (canEdit && Model.TotalStudents > 0)
    {
        <div class="quick-actions">
            <h3><i class="fas fa-bolt"></i> Điểm danh nhanh</h3>
            <div class="quick-buttons">
                @using (Html.BeginRouteForm("LecturerActivities", new { action = "MarkAllPresent" }, FormMethod.Post))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="activityId" value="@Model.ActivityId" />
                    <button type="submit" class="btn btn-success btn-lg" style="width: 100%;"
                            onclick="return confirm('Đánh dấu TẤT CẢ sinh viên CÓ MẶT?');">
                        <i class="fas fa-check-double"></i> Tất cả CÓ MẶT
                    </button>
                }
                @using (Html.BeginRouteForm("LecturerActivities", new { action = "MarkAllAbsent" }, FormMethod.Post))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="activityId" value="@Model.ActivityId" />
                    <button type="submit" class="btn btn-danger btn-lg" style="width: 100%;"
                            onclick="return confirm('Đánh dấu TẤT CẢ sinh viên VẮNG MẶT?');">
                        <i class="fas fa-times"></i> Tất cả VẮNG
                    </button>
                }
            </div>
        </div>
    }

    <!-- Attendance Table -->
    <div class="card">
        <div class="filter-bar">
            <input type="text" id="searchInput" class="form-control" placeholder="Tìm theo tên hoặc MSSV..." 
                   value="@Model.SearchKeyword" style="min-width: 250px;" />
            <select id="filterSelect" class="form-control">
                <option value="ALL" @(Model.FilterStatus == "ALL" ? "selected" : "")>Tất cả</option>
                <option value="PENDING" @(Model.FilterStatus == "PENDING" ? "selected" : "")>Chưa điểm danh</option>
                <option value="PRESENT" @(Model.FilterStatus == "PRESENT" ? "selected" : "")>Có mặt</option>
                <option value="ABSENT" @(Model.FilterStatus == "ABSENT" ? "selected" : "")>Vắng</option>
            </select>
            <button class="btn btn-primary" onclick="applyFilter()">
                <i class="fas fa-search"></i> Lọc
            </button>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th style="width: 60px;">STT</th>
                    <th>Sinh viên</th>
                    <th>Lớp</th>
                    <th style="width: 180px;">Trạng thái</th>
                    <th style="width: 150px;">Thời gian</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int stt = 1;
                    foreach (var record in Model.Records)
                    {
                        string selectClass = record.AttendanceStatus.ToLower();
                        <tr>
                            <td>@(stt++)</td>
                            <td>
                                <div class="student-name">@record.StudentName</div>
                                <div class="student-code">@record.StudentCode</div>
                            </td>
                            <td>@record.ClassName</td>
                            <td>
                                @if (canEdit && !record.ScoreApplied)
                                {
                                    <select class="attendance-select @selectClass"
                                            data-registration-id="@record.RegistrationId"
                                            data-activity-id="@Model.ActivityId"
                                            onchange="updateAttendance(this)">
                                        <option value="PENDING" @(record.AttendanceStatus == "PENDING" ? "selected" : "")>⏳ Chưa điểm danh</option>
                                        <option value="PRESENT" @(record.AttendanceStatus == "PRESENT" ? "selected" : "")>✅ Có mặt</option>
                                        <option value="ABSENT" @(record.AttendanceStatus == "ABSENT" ? "selected" : "")>❌ Vắng</option>
                                    </select>
                                }
                                else
                                {
                                    if (record.AttendanceStatus == "PRESENT")
                                    {
                                        <span class="badge badge-present"><i class="fas fa-check"></i> Có mặt</span>
                                    }
                                    else if (record.AttendanceStatus == "ABSENT")
                                    {
                                        <span class="badge badge-absent"><i class="fas fa-times"></i> Vắng</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-pending"><i class="fas fa-clock"></i> Chưa điểm danh</span>
                                    }
                                    if (record.ScoreApplied)
                                    {
                                        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Đã tính điểm</div>
                                    }
                                }
                            </td>
                            <td style="color: #64748b;">
                                @if (record.CheckedInAt.HasValue)
                                {
                                    @record.CheckedInAt.Value.ToString("dd/MM HH:mm")
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- Confirm Section -->
    @if (!isConfirmed && Model.TotalStudents > 0 && Model.PendingCount == 0)
    {
        <div class="confirm-section">
            <h3><i class="fas fa-check-circle"></i> Xác nhận và Tính điểm</h3>
            <div class="score-grid">
                <div class="score-item">
                    <div class="label">Có mặt (@Model.PresentCount SV)</div>
                    <div class="value positive">+@(Model.PresentCount * Model.ActivityPoints) điểm</div>
                </div>
                <div class="score-item">
                    <div class="label">Vắng (@Model.AbsentCount SV)</div>
                    <div class="value negative">-@(Model.AbsentCount * Model.AbsencePenalty) điểm</div>
                </div>
            </div>
            @using (Html.BeginRouteForm("LecturerActivities", new { action = "ConfirmAttendance" }, FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <input type="hidden" name="activityId" value="@Model.ActivityId" />
                <button type="submit" class="btn btn-success btn-lg"
                        onclick="return confirm('Xác nhận điểm danh và tính điểm cho sinh viên?\n\nHành động này không thể hoàn tác!');">
                    <i class="fas fa-check-double"></i> Xác nhận & Tính điểm
                </button>
            }
        </div>
    }

    @if (isConfirmed)
    {
        <div class="confirmed-section">
            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #166534;">
                <i class="fas fa-check-double"></i> Đã xác nhận điểm danh
            </h3>
            <p style="margin: 0; color: #166534;">
                Xác nhận bởi: <strong>@Model.ConfirmedByName</strong> lúc @(Model.ConfirmedAt.HasValue ? Model.ConfirmedAt.Value.ToString("dd/MM/yyyy HH:mm") : "")
            </p>
        </div>
    }
</div>

@section Scripts {
    <script>
        function applyFilter() {
            var search = document.getElementById('searchInput').value;
            var filter = document.getElementById('filterSelect').value;
            var url = '@Url.RouteUrl("LecturerActivities", new { action = "Attendance", id = Model.ActivityId })';
            url += '?filterStatus=' + filter;
            if (search) {
                url += '&search=' + encodeURIComponent(search);
            }
            window.location.href = url;
        }

        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                applyFilter();
            }
        });

        function updateAttendance(selectElement) {
            var regId = selectElement.getAttribute('data-registration-id');
            var actId = selectElement.getAttribute('data-activity-id');
            var status = selectElement.value;

            // Update visual class
            selectElement.className = 'attendance-select ' + status.toLowerCase();

            if (status === 'PENDING') {
                return;
            }

            var formData = new FormData();
            formData.append('registrationId', regId);
            formData.append('status', status);
            formData.append('activityId', actId);
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

            fetch('@Url.RouteUrl("LecturerActivities", new { action = "UpdateAttendance" })', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Lỗi: ' + data.message);
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra!');
            });
        }
    </script>
}
