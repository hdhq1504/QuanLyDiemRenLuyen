@model QuanLyDiemRenLuyen.Models.AuditLogsViewModel
@{
    ViewBag.Title = "Nhật ký hệ thống";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .audit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .audit-header h2 {
        margin: 0;
        color: #0f172a;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        text-align: center;
    }

    .stat-card h3 {
        font-size: 28px;
        font-weight: 700;
        color: #2563eb;
        margin: 0 0 4px 0;
    }

    .stat-card p {
        color: #64748b;
        font-size: 13px;
        margin: 0;
    }

    .filter-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        margin-bottom: 24px;
    }

    .filter-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        flex: 1;
        min-width: 150px;
    }

    .filter-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: #475569;
        margin-bottom: 4px;
    }

    .filter-group input,
    .filter-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
    }

    .card {
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th {
        background: #f8fafc;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #0f172a;
        border-bottom: 1px solid #e2e8f0;
        font-size: 13px;
    }

    .table td {
        padding: 12px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 13px;
        vertical-align: top;
    }

    .table tr:hover {
        background: #f8fafc;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-secondary {
        background: #f1f5f9;
        color: #475569;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
        cursor: pointer;
        border: none;
    }

    .btn-primary {
        background: #2563eb;
        color: white;
    }

    .btn-primary:hover {
        background: #1e40af;
        color: white;
        text-decoration: none;
    }

    .btn-secondary {
        background: #f1f5f9;
        color: #475569;
    }

    .btn-sm {
        padding: 6px 10px;
        font-size: 12px;
    }

    .justification-text {
        font-size: 12px;
        color: #059669;
        font-style: italic;
        margin-top: 4px;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        padding: 20px;
    }

    .pagination a,
    .pagination span {
        padding: 8px 14px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 13px;
    }

    .pagination a {
        background: #f1f5f9;
        color: #475569;
    }

    .pagination a:hover {
        background: #e2e8f0;
    }

    .pagination .active {
        background: #2563eb;
        color: white;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .record-link {
        color: #2563eb;
        text-decoration: none;
        font-weight: 500;
    }

    .record-link:hover {
        text-decoration: underline;
    }

    .user-info {
        display: flex;
        flex-direction: column;
    }

    .user-name {
        font-weight: 500;
        color: #0f172a;
    }

    .user-id {
        font-size: 11px;
        color: #94a3b8;
    }
</style>

<div class="audit-header">
    <h2><i class="fas fa-history"></i> Nhật ký hệ thống</h2>
    <div>
        <a href="@Url.Action("DailySummary")" class="btn btn-secondary">
            <i class="fas fa-chart-bar"></i> Thống kê
        </a>
    </div>
</div>

<!-- Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <h3>@Model.Statistics.TodayCount</h3>
        <p>Thay đổi hôm nay</p>
    </div>
    <div class="stat-card">
        <h3>@Model.Statistics.WeekCount</h3>
        <p>Thay đổi 7 ngày</p>
    </div>
    <div class="stat-card">
        <h3>@Model.Statistics.TodayUsers</h3>
        <p>Người dùng hoạt động</p>
    </div>
    <div class="stat-card">
        <h3>@Model.Statistics.ScoresChanges</h3>
        <p>Thay đổi điểm (7 ngày)</p>
    </div>
</div>

<!-- Filters -->
<div class="filter-card">
    <form method="get" action="@Url.Action("Index")">
        <div class="filter-row">
            <div class="filter-group">
                <label>Bảng</label>
                <select name="tableName">
                    <option value="">-- Tất cả --</option>
                    @foreach (var table in Model.AvailableTables)
                    {
                        <option value="@table" @(Model.TableName == table ? "selected" : "")>@table</option>
                    }
                </select>
            </div>
            <div class="filter-group">
                <label>Thao tác</label>
                <select name="operation">
                    <option value="">-- Tất cả --</option>
                    <option value="INSERT" @(Model.Operation == "INSERT" ? "selected" : "")>INSERT</option>
                    <option value="UPDATE" @(Model.Operation == "UPDATE" ? "selected" : "")>UPDATE</option>
                    <option value="DELETE" @(Model.Operation == "DELETE" ? "selected" : "")>DELETE</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Người thực hiện</label>
                <input type="text" name="userId" value="@Model.UserId" placeholder="Mã người dùng...">
            </div>
            <div class="filter-group">
                <label>Từ ngày</label>
                <input type="date" name="fromDate" value="@Model.FromDate.ToString("yyyy-MM-dd")">
            </div>
            <div class="filter-group">
                <label>Đến ngày</label>
                <input type="date" name="toDate" value="@Model.ToDate.ToString("yyyy-MM-dd")">
            </div>
            <div class="filter-group" style="flex: 0;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> Lọc
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Audit Logs Table -->
<div class="card">
    @if (Model.AuditLogs != null && Model.AuditLogs.Count > 0)
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Thời gian</th>
                    <th>Bảng</th>
                    <th>Thao tác</th>
                    <th>Record ID</th>
                    <th>Người thực hiện</th>
                    <th>Thay đổi</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var log in Model.AuditLogs)
                {
                    <tr>
                        <td>
                            <div>@log.PerformedAt.ToString("dd/MM/yyyy")</div>
                            <div style="font-size: 11px; color: #94a3b8;">@log.PerformedAt.ToString("HH:mm:ss")</div>
                        </td>
                        <td>
                            <span class="badge badge-secondary">@log.TableName</span>
                        </td>
                        <td>
                            <span class="badge @log.OperationBadgeClass">@log.OperationDisplayName</span>
                        </td>
                        <td>
                            <span class="record-link" style="cursor: pointer;" onclick="showHistory('@log.TableName', '@log.RecordId')">
                                @log.RecordId
                            </span>
                        </td>
                        <td>
                            <div class="user-info">
                                <span class="user-name">@(log.PerformerName ?? log.PerformedBy ?? "System")</span>
                                @if (!string.IsNullOrEmpty(log.PerformedBy))
                                {
                                    <span class="user-id">@log.PerformedBy</span>
                                }
                            </div>
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(log.ChangedColumns))
                            {
                                <span style="font-size: 12px;">@log.ChangedColumns</span>
                            }
                            @if (!string.IsNullOrEmpty(log.Justification))
                            {
                                <div class="justification-text">
                                    <i class="fas fa-comment"></i> @log.Justification
                                </div>
                            }
                        </td>
                        <td>
                            <a href="@Url.Action("Detail", new { id = log.Id })" class="btn btn-sm btn-secondary">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    @if (Model.AuditLogs != null && Model.AuditLogs.Count > 0 && Model.TotalPages > 1)
    {
        <div class="pagination">
            @if (Model.CurrentPage > 1)
            {
                <a href="@Url.Action("Index", new { tableName = Model.TableName, operation = Model.Operation, userId = Model.UserId, fromDate = Model.FromDate.ToString("yyyy-MM-dd"), toDate = Model.ToDate.ToString("yyyy-MM-dd"), page = Model.CurrentPage - 1 })">
                    <i class="fas fa-chevron-left"></i>
                </a>
            }

            @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
            {
                if (i == Model.CurrentPage)
                {
                    <span class="active">@i</span>
                }
                else
                {
                    <a href="@Url.Action("Index", new { tableName = Model.TableName, operation = Model.Operation, userId = Model.UserId, fromDate = Model.FromDate.ToString("yyyy-MM-dd"), toDate = Model.ToDate.ToString("yyyy-MM-dd"), page = i })">@i</a>
                }
            }

            @if (Model.CurrentPage < Model.TotalPages)
            {
                <a href="@Url.Action("Index", new { tableName = Model.TableName, operation = Model.Operation, userId = Model.UserId, fromDate = Model.FromDate.ToString("yyyy-MM-dd"), toDate = Model.ToDate.ToString("yyyy-MM-dd"), page = Model.CurrentPage + 1 })">
                    <i class="fas fa-chevron-right"></i>
                </a>
            }
        </div>
    }
    
    @if (Model.AuditLogs == null || Model.AuditLogs.Count == 0)
    {
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>Không có dữ liệu audit trong khoảng thời gian này</p>
        </div>
    }
</div>

<!-- Inline History Panel -->
<div id="historyPanel" class="card" style="display: none; margin-top: 24px;">
    <div style="padding: 16px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
        <h4 style="margin: 0; font-size: 16px;"><i class="fas fa-history"></i> Lịch sử thay đổi</h4>
        <button onclick="closeHistory()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #64748b;">&times;</button>
    </div>
    <div id="historyContent" style="padding: 20px;">
        <p>Đang tải...</p>
    </div>
</div>

@section Scripts {
    <script>
        function showHistory(tableName, recordId) {
            $('#historyContent').html('<p style="text-align: center; color: #64748b;"><i class="fas fa-spinner fa-spin"></i> Đang tải...</p>');
            $('#historyPanel').slideDown();
            
            // Scroll to history panel
            $('html, body').animate({
                scrollTop: $('#historyPanel').offset().top - 100
            }, 300);
            
            $.get('@Url.Action("RecordHistory")' + '?tableName=' + tableName + '&recordId=' + recordId, function(data) {
                $('#historyContent').html(data);
            }).fail(function(xhr, status, error) {
                $('#historyContent').html('<p style="color: #dc2626; text-align: center;"><i class="fas fa-exclamation-circle"></i> Không thể tải lịch sử: ' + error + '</p>');
            });
        }
        
        function closeHistory() {
            $('#historyPanel').slideUp();
        }
    </script>
}
