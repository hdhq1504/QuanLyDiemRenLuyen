@model QuanLyDiemRenLuyen.Models.ParticipantsViewModel
@{
    ViewBag.Title = "Điểm danh - " + Model.ActivityTitle;
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div style="padding: 24px;">
    <!-- Header with Back Button -->
    <div style="margin-bottom: 24px;">
        <a href="@Url.Action("Index", "Activities")" style="color: #64748b; text-decoration: none; font-weight: 500;">
            <i class="fas fa-arrow-left"></i> Quay lại danh sách hoạt động
        </a>
    </div>

    <!-- Activity Info Card -->
    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
        <h2 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700; color: #0f172a;">
            <i class="fas fa-user-check" style="color: #2563eb;"></i> Điểm danh: @Model.ActivityTitle
        </h2>
        <div style="display: flex; gap: 24px; color: #64748b; font-size: 14px;">
            <span><i class="fas fa-calendar"></i> @Model.ActivityStartAt.ToString("dd/MM/yyyy HH:mm")</span>
            <span><i class="fas fa-clock"></i> @Model.ActivityEndAt.ToString("dd/MM/yyyy HH:mm")</span>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <!-- Total Registered -->
        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="color: #64748b; font-size: 14px; margin-bottom: 8px;">Tổng đăng ký</div>
            <div style="font-size: 32px; font-weight: 700; color: #0f172a;">@Model.TotalRegistered</div>
        </div>

        <!-- Total Checked In -->
        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="color: #64748b; font-size: 14px; margin-bottom: 8px;">Đã điểm danh</div>
            <div style="font-size: 32px; font-weight: 700; color: #10b981;">@Model.TotalCheckedIn</div>
        </div>

        <!-- Attendance Rate -->
        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="color: #64748b; font-size: 14px; margin-bottom: 8px;">Tỷ lệ điểm danh</div>
            <div style="font-size: 32px; font-weight: 700; color: #2563eb;">@Model.AttendanceRate.ToString("0.0")%</div>
        </div>
    </div>

    <!-- Filters & Bulk Actions -->
    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
        @using (Html.BeginForm("Participants", "Activities", FormMethod.Get, new { style = "display: flex; gap: 12px; align-items: center; flex-wrap: wrap;" }))
        {
            <input type="hidden" name="id" value="@Model.ActivityId" />
            
            <select name="filterStatus" style="padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="ALL" @(Model.FilterStatus == "ALL" ? "selected" : "")>Tất cả trạng thái</option>
                <option value="REGISTERED" @(Model.FilterStatus == "REGISTERED" ? "selected" : "")>Chưa điểm danh</option>
                <option value="CHECKED_IN" @(Model.FilterStatus == "CHECKED_IN" ? "selected" : "")>Đã điểm danh</option>
            </select>

            <input type="text" name="search" value="@Model.SearchKeyword" 
                   placeholder="Tìm theo tên hoặc MSSV..." 
                   style="padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; flex: 1; min-width: 200px;" />

            <button type="submit" style="padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-search"></i> Tìm kiếm
            </button>

            <a href="@Url.Action("ExportParticipants", "Activities", new { id = Model.ActivityId })" 
               style="padding: 10px 20px; background: #059669; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; text-decoration: none;">
                <i class="fas fa-file-csv"></i> Xuất CSV
            </a>

            <button type="button" id="btnBulkCheckIn" 
                    style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-left: auto;">
                <i class="fas fa-check-double"></i> Điểm danh hàng loạt (<span id="selectedCount">0</span>)
            </button>
        }
    </div>

    <!-- Participants Table -->
    @if (Model.Participants != null && Model.Participants.Any())
    {
        <div style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                    <tr>
                        <th style="padding: 16px; text-align: left;">
                            <input type="checkbox" id="checkAll" style="cursor: pointer;" />
                        </th>
                        <th style="padding: 16px; text-align: left; font-weight: 700; color: #0f172a;">MSSV</th>
                        <th style="padding: 16px; text-align: left; font-weight: 700; color: #0f172a;">Họ và tên</th>
                        <th style="padding: 16px; text-align: left; font-weight: 700; color: #0f172a;">Lớp</th>
                        <th style="padding: 16px; text-align: left; font-weight: 700; color: #0f172a;">Trạng thái</th>
                        <th style="padding: 16px; text-align: left; font-weight: 700; color: #0f172a;">Thời gian ĐK</th>
                        <th style="padding: 16px; text-align: left; font-weight: 700; color: #0f172a;">Minh chứng</th>
                        <th style="padding: 16px; text-align: center; font-weight: 700; color: #0f172a; width: 150px;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var participant in Model.Participants)
                    {
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 16px;">
                                @if (participant.Status == "REGISTERED")
                                {
                                    <input type="checkbox" class="participant-checkbox" 
                                           value="@participant.RegistrationId" 
                                           style="cursor: pointer;" />
                                }
                            </td>
                            <td style="padding: 16px;">
                                <strong style="color: #0f172a;">@participant.StudentCode</strong>
                            </td>
                            <td style="padding: 16px;">
                                <div style="color: #0f172a; font-weight: 600;">@participant.StudentName</div>
                                <div style="color: #64748b; font-size: 12px;">@participant.StudentEmail</div>
                            </td>
                            <td style="padding: 16px; color: #64748b;">
                                @participant.ClassName
                            </td>
                            <td style="padding: 16px;">
                                @if (participant.Status == "CHECKED_IN")
                                {
                                    <span style="background: #d1fae5; color: #065f46; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;">
                                        <i class="fas fa-check-circle"></i> Đã điểm danh
                                    </span>
                                    @if (participant.CheckedInAt.HasValue)
                                    {
                                        <div style="color: #64748b; font-size: 12px; margin-top: 4px;">
                                            @participant.CheckedInAt.Value.ToString("dd/MM HH:mm")
                                            @if (!string.IsNullOrEmpty(participant.CheckedInByName))
                                            {
                                                <span style="margin-left: 4px;">bởi <strong>@participant.CheckedInByName</strong></span>
                                            }
                                        </div>
                                    }
                                }
                                else
                                {
                                    <span style="background: #fef3c7; color: #92400e; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;">
                                        <i class="fas fa-clock"></i> Chưa điểm danh
                                    </span>
                                }
                            </td>
                            <td style="padding: 16px; color: #64748b; font-size: 13px;">
                                @participant.RegisteredAt.ToString("dd/MM/yyyy HH:mm")
                            </td>
                            <td style="padding: 16px;">
                                @if (participant.HasProof)
                                {
                                    if (participant.ProofStatus == "APPROVED")
                                    {
                                        <span style="background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                            <i class="fas fa-check"></i> Đã duyệt
                                        </span>
                                    }
                                    else if (participant.ProofStatus == "SUBMITTED")
                                    {
                                        <span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                            <i class="fas fa-clock"></i> Chờ duyệt
                                        </span>
                                    }
                                    else if (participant.ProofStatus == "REJECTED")
                                    {
                                        <span style="background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                            <i class="fas fa-times"></i> Từ chối
                                        </span>
                                    }
                                }
                                else
                                {
                                    <span style="color: #9ca3af; font-size: 12px;">Chưa nộp</span>
                                }
                            </td>
                            <td style="padding: 16px; text-align: center;">
                                @if (participant.Status == "REGISTERED")
                                {
                                    using (Html.BeginForm("CheckIn", "Activities", FormMethod.Post, new { style = "display: inline;" }))
                                    {
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="registrationId" value="@participant.RegistrationId" />
                                        <input type="hidden" name="activityId" value="@Model.ActivityId" />
                                        <button type="submit" 
                                                style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;"
                                                onclick="return confirm('Xác nhận điểm danh sinh viên @participant.StudentName?')">
                                            <i class="fas fa-user-check"></i> Điểm danh
                                        </button>
                                    }
                                }
                                else
                                {
                                    using (Html.BeginForm("UnCheckIn", "Activities", FormMethod.Post, new { style = "display: inline;" }))
                                    {
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="registrationId" value="@participant.RegistrationId" />
                                        <input type="hidden" name="activityId" value="@Model.ActivityId" />
                                        <button type="submit" 
                                                style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;"
                                                onclick="return confirm('Xác nhận HỦY điểm danh sinh viên @participant.StudentName?')">
                                            <i class="fas fa-undo"></i> Hủy điểm danh
                                        </button>
                                    }
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div style="margin-top: 24px; display: flex; justify-content: center; gap: 8px;">
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <a href="@Url.Action("Participants", new { id = Model.ActivityId, filterStatus = Model.FilterStatus, search = Model.SearchKeyword, page = i })"
                       style="padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; @(i == Model.CurrentPage ? "background: #2563eb; color: white;" : "background: white; color: #64748b; border: 1px solid #e2e8f0;")">
                        @i
                    </a>
                }
            </div>
        }
    }
    else
    {
        <div style="background: white; padding: 60px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
            <i class="fas fa-users" style="font-size: 48px; color: #e2e8f0; margin-bottom: 16px;"></i>
            <p style="color: #64748b; font-size: 16px; margin: 0;">Không có sinh viên đăng ký hoặc không tìm thấy kết quả.</p>
        </div>
    }
</div>

<!-- Hidden form for bulk check-in -->
<form id="bulkCheckInForm" action="@Url.Action("BulkCheckIn", "Activities")" method="post" style="display:none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="activityId" value="@Model.ActivityId" />
    <input type="hidden" name="registrationIds" id="bulkRegistrationIds" />
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const checkAll = document.getElementById('checkAll');
        const checkboxes = document.querySelectorAll('.participant-checkbox');
        const selectedCountSpan = document.getElementById('selectedCount');
        const btnBulkCheckIn = document.getElementById('btnBulkCheckIn');

        function updateSelectedCount() {
            const selected = document.querySelectorAll('.participant-checkbox:checked');
            selectedCountSpan.textContent = selected.length;
            
            if (selected.length > 0) {
                btnBulkCheckIn.style.display = 'inline-block';
            } else {
                btnBulkCheckIn.style.display = 'none';
            }
        }

        // Check all functionality
        checkAll.addEventListener('change', function () {
            checkboxes.forEach(cb => {
                cb.checked = checkAll.checked;
            });
            updateSelectedCount();
        });

        // Individual checkbox change
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateSelectedCount);
        });

        // Bulk check-in
        btnBulkCheckIn.addEventListener('click', function () {
            const selected = document.querySelectorAll('.participant-checkbox:checked');
            
            if (selected.length === 0) {
                alert('Vui lòng chọn ít nhất một sinh viên để điểm danh.');
                return;
            }

            if (confirm(`Xác nhận điểm danh ${selected.length} sinh viên đã chọn?`)) {
                const ids = Array.from(selected).map(cb => cb.value).join(',');
                document.getElementById('bulkRegistrationIds').value = ids;
                document.getElementById('bulkCheckInForm').submit();
            }
        });

        // Initial count
        updateSelectedCount();
    });
</script>
